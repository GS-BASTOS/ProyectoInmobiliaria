<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Cliente')}"></head>
<style>
  /* ‚îÄ‚îÄ Combobox inmueble ‚îÄ‚îÄ */
  .combo-wrapper { position:relative; width:100%; }
  .combo-input   { width:100%; cursor:pointer; }
  .combo-dropdown {
    display:none; position:absolute; z-index:999;
    top:calc(100% + 4px); left:0; right:0;
    background:#fff; border:1px solid var(--line);
    border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,0.10);
    max-height:260px; overflow-y:auto;
  }
  .combo-dropdown.open { display:block; }
  .combo-option {
    padding:9px 14px; cursor:pointer; font-size:13px;
    border-bottom:1px solid var(--line); transition:background 0.12s;
  }
  .combo-option:last-child { border-bottom:none; }
  .combo-option:hover,
  .combo-option.highlighted { background:#f0ede8; }
  .combo-option .opt-code { font-weight:700; color:var(--text); }
  .combo-option .opt-sub  { color:#888; font-size:11px; margin-top:1px; }
  .combo-empty { padding:12px 14px; color:#aaa; font-size:13px; text-align:center; }
</style>
<body>

<!-- ‚îÄ‚îÄ CSRF meta tags ‚îÄ‚îÄ -->
<meta name="_csrf"        th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<nav th:replace="~{fragments :: nav}"></nav>

<div class="container">

  <!-- PERFIL -->
  <div class="card"
       th:style="${client.posibleOcupa
                   ? 'border-left:6px solid #b42318;'
                   : client.compradorFinal
                     ? 'border-left:6px solid #168a53;'
                     : 'border-left:6px solid var(--line);'}">

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <h2 style="margin:0;" th:text="${client.fullName}">Cliente</h2>

      <span th:if="${client.compradorFinal}"
            style="display:inline-flex; align-items:center; gap:6px;
                   background:#e8f5e9; border:1px solid #168a53;
                   border-radius:999px; padding:4px 12px;
                   font-size:13px; color:#168a53; font-weight:800;
                   letter-spacing:0.4px; text-transform:uppercase;
                   box-shadow:0 0 0 3px rgba(22,138,83,.12);">
        üí∞ COMPRADOR
      </span>

      <span th:if="${client.posibleOcupa}"
            style="display:inline-flex; align-items:center; gap:6px;
                   background:#ffebee; border:1px solid #b42318;
                   border-radius:999px; padding:4px 12px;
                   font-size:12px; color:#b42318; font-weight:800;
                   letter-spacing:0.4px; text-transform:uppercase;
                   box-shadow:0 0 0 3px rgba(180,35,24,.12);">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
             fill="none" stroke="#b42318" stroke-width="2.5"
             stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        POSIBLE OKUPA
      </span>
    </div>

    <div th:if="${client.posibleOcupa
                  and client.generalNotes != null
                  and !#strings.isEmpty(client.generalNotes)}"
         style="margin-top:8px; padding:8px 12px; background:#ffebee;
                border-left:4px solid #b42318; border-radius:6px;
                color:#b42318; font-size:13px;">
      <strong>Nota:</strong> <span th:text="${client.generalNotes}"></span>
    </div>

    <div th:if="${client.compradorFinal}"
         style="margin-top:8px; padding:8px 12px; background:#e8f5e9;
                border-left:4px solid #168a53; border-radius:6px;
                color:#168a53; font-size:13px;">
      <strong>üí∞ Comprador confirmado.</strong> Las interacciones y el formulario est√°n desactivados.
    </div>

    <div class="small" style="margin-top:6px;">Informaci√≥n del cliente</div>
    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <div class="grid">
      <div>
        <div class="small">Tipo</div>
        <div th:text="${client.clientType}">PARTICULAR</div>
      </div>
      <div th:if="${client.companyName != null and !#strings.isEmpty(client.companyName)}">
        <div class="small">Empresa</div>
        <div th:text="${client.companyName}">‚Äî</div>
      </div>
      <div>
        <div class="small">C√≥digo Solvia</div>
        <div th:text="${client.solviaCode != null and !#strings.isEmpty(client.solviaCode)
                         ? client.solviaCode : '‚Äî'}">‚Äî</div>
      </div>
      <div>
        <div class="small">Tel√©fonos</div>
        <div>
          <span th:if="${#lists.isEmpty(client.phones)}">‚Äî</span>
          <span th:each="p,st : ${client.phones}"
                th:text="${p.phoneNumber} + ${!st.last ? ', ' : ''}">600000000</span>
        </div>
      </div>
      <div>
        <div class="small">Emails</div>
        <div>
          <span th:if="${#lists.isEmpty(client.emails)}">‚Äî</span>
          <span th:each="e,st : ${client.emails}"
                th:text="${e.email} + ${!st.last ? ', ' : ''}">mail@mail.com</span>
        </div>
      </div>
      <div th:if="${!client.posibleOcupa}" style="grid-column:1/-1;">
        <div class="small">Notas</div>
        <div th:text="${client.generalNotes != null and !#strings.isEmpty(client.generalNotes)
                         ? client.generalNotes : '‚Äî'}">‚Äî</div>
      </div>
    </div>

    <div class="actions">
      <a class="btn btn-secondary" th:href="@{|/clientes/${client.id}#editar|}">Editar</a>
      <a class="btn btn-secondary" th:href="@{/clientes}">Volver a clientes</a>
    </div>
  </div>

  <!-- INTERACCIONES -->
  <div class="card" style="margin-top:24px; border-top:3px solid var(--text);">
    <h2>Interacciones</h2>
    <div class="small">Hist√≥rico de contacto del cliente</div>
    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <table>
      <thead>
      <tr>
        <th>Fecha</th>
        <th>Inmueble</th>
        <th>NDA</th>
        <th>Ticket</th>
        <th>Canal</th>
        <th>Estado</th>
        <th style="min-width:320px;">Comentarios</th>
      </tr>
      </thead>
      <tbody>
      <tr th:if="${#lists.isEmpty(interactions)}">
        <td colspan="7" class="small">A√∫n no hay interacciones registradas.</td>
      </tr>
      <tr th:each="it : ${interactions}"
          th:style="${client.compradorFinal and it.property.sold
                      ? 'background:#e8f5e9; border-left:3px solid #168a53;'
                      : client.compradorFinal
                        ? 'opacity:0.35; pointer-events:none;'
                        : client.posibleOcupa
                          ? 'background:#fff8f8;'
                          : ''}">
        <td th:text="${#temporals.format(it.contactDate, 'dd/MM/yyyy')}">13/02/2026</td>

        <!-- INMUEBLE -->
        <td>
          <div><strong th:text="${it.property.propertyCode}">-</strong></div>
          <div class="small"
               th:if="${it.property.propertyType != null and !#strings.isEmpty(it.property.propertyType)}"
               th:text="${it.property.propertyType}">Tipo</div>
          <div class="small"
               th:if="${it.property.address != null and !#strings.isEmpty(it.property.address)}"
               th:text="${it.property.address}">Direcci√≥n</div>
          <div class="small"
               th:if="${it.property.municipality != null and !#strings.isEmpty(it.property.municipality)}"
               th:text="${it.property.municipality}">Municipio</div>

          <a th:if="${it.property.sold}"
             th:href="${it.property.soldClient != null
                        ? '/clientes/' + it.property.soldClient.id
                        : '/clientes/' + it.client.id}"
             style="margin-top:4px; display:inline-flex; align-items:center; gap:4px;
                    background:#e8f5e9; border:1px solid #168a53; border-radius:999px;
                    padding:2px 8px; font-size:11px; color:#168a53; font-weight:700;
                    text-decoration:none; transition:box-shadow .15s; white-space:nowrap;"
             onmouseover="this.style.boxShadow='0 0 0 3px rgba(22,138,83,.2)'"
             onmouseout="this.style.boxShadow='none'">
            üí∞ Comprado
            <span th:if="${it.property.soldClient != null}"
                  th:text="${' ¬∑ ' + it.property.soldClient.fullName}"></span>
          </a>

          <a th:if="${!it.property.sold and it.property.preVendido}"
             th:href="${it.property.preVendidoClient != null
                        ? '/clientes/' + it.property.preVendidoClient.id
                        : '#'}"
             style="margin-top:4px; display:inline-flex; align-items:center; gap:4px;
                    background:#fff4e6; border:1px solid #e07a18; border-radius:999px;
                    padding:2px 8px; font-size:11px; color:#a05800; font-weight:700;
                    text-decoration:none; transition:box-shadow .15s; white-space:nowrap;"
             onmouseover="this.style.boxShadow='0 0 0 3px rgba(224,122,24,.2)'"
             onmouseout="this.style.boxShadow='none'">
            ‚è≥ Pre vendido
            <span th:if="${it.property.preVendidoClient != null}"
                  th:text="${' ¬∑ ' + it.property.preVendidoClient.fullName}"></span>
          </a>
        </td>

        <!-- NDA -->
        <td style="text-align:center;">
          <input type="checkbox" class="nda-toggle"
                 th:attr="data-client-id=${client.id},data-interaction-id=${it.id}"
                 th:checked="${it.ndaRequested}" />
        </td>

        <!-- TICKET -->
        <td style="min-width:130px;">
          <input type="text" class="ticket-input"
                 th:attr="data-client-id=${client.id},data-interaction-id=${it.id}"
                 th:value="${it.ticketCode}"
                 placeholder="C√≥digo ticket..."
                 style="width:100%; font-size:12px; padding:5px 8px;"/>
          <div style="display:flex; gap:6px; margin-top:4px; align-items:center;">
            <button type="button" class="ticket-save"
                    th:attr="data-client-id=${client.id},data-interaction-id=${it.id}"
                    style="padding:3px 8px; font-size:11px;">Guardar</button>
            <span class="ticket-feedback small"
                  style="display:none; color:#4caf50;">‚úì</span>
          </div>
        </td>

        <!-- CANAL -->
        <td th:text="${it.channel}">-</td>

        <!-- ESTADO -->
        <td>
          <select class="status-select"
                  th:attr="data-client-id=${client.id},data-interaction-id=${it.id}">
            <option th:each="s : ${statuses}"
                    th:value="${s}" th:text="${s}"
                    th:selected="${s == it.status}"></option>
          </select>
          <span class="badge" style="margin-left:8px;">
            <span class="dot status-dot" th:attr="data-status=${it.status}"></span>
          </span>
        </td>

        <!-- COMENTARIOS -->
        <td style="min-width:320px;">
          <textarea class="comments-input"
                    th:attr="data-client-id=${client.id},data-interaction-id=${it.id}"
                    th:text="${it.comments}" rows="3"
                    style="width:100%; min-width:300px; resize:vertical; font-size:13px;"></textarea>
          <div style="display:flex; gap:6px; margin-top:4px; align-items:center;">
            <button type="button" class="comments-save"
                    th:attr="data-client-id=${client.id},data-interaction-id=${it.id}"
                    style="padding:4px 10px; font-size:12px;">Guardar</button>
            <span class="comments-feedback small"
                  style="display:none; color:#4caf50;">‚úì Guardado</span>
          </div>
        </td>
      </tr>
      </tbody>
    </table>

    <div th:if="${client.compradorFinal}"
         style="margin-top:12px; padding:10px 14px; background:#e8f5e9;
                border-left:4px solid #168a53; border-radius:6px;
                font-size:13px; color:#168a53;">
      <strong>üí∞ COMPRADOR:</strong> Las interacciones anteriores est√°n desactivadas.
    </div>
  </div>

  <!-- NUEVA INTERACCI√ìN -->
  <div class="card" style="margin-top:24px;"
       th:style="${client.compradorFinal ? 'opacity:0.4; pointer-events:none;' : ''}">
    <h2>Nueva interacci√≥n</h2>
    <div class="small" th:if="${client.compradorFinal}" style="color:#168a53; margin-bottom:8px;">
      Este cliente ya ha comprado un inmueble.
    </div>
    <div class="small" th:if="${!client.compradorFinal}">A√±adir un nuevo contacto del cliente</div>
    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <form th:action="@{|/clientes/${client.id}/interacciones|}"
          th:object="${newInteraction}" method="post">
      <div class="grid-3">
        <div><label>Fecha</label><input type="date" th:field="*{contactDate}" /></div>
        <div><label>Canal</label>
          <select th:field="*{channel}">
            <option th:each="c : ${channels}" th:value="${c}" th:text="${c}"></option>
          </select>
        </div>
        <div><label>Estado</label>
          <select th:field="*{status}">
            <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
          </select>
        </div>
      </div>

      <!-- ‚ïê‚ïê COMBOBOX INMUEBLE ‚ïê‚ïê -->
      <div style="margin-top:14px;">
        <label style="font-weight:600;">Seleccionar inmueble del cat√°logo</label>
        <div class="small" style="margin-bottom:6px; color:#888;">
          Disponibles y pre vendidos. Escribe o haz clic para buscar.
        </div>
        <div class="combo-wrapper" id="niComboWrapper">
          <input type="text" id="niComboInput" class="combo-input"
                 placeholder="üîç  Buscar por c√≥digo, municipio, tipo..."
                 autocomplete="off" readonly/>
          <div class="combo-dropdown" id="niComboDropdown"></div>
        </div>
        <div id="niComboChip"
             style="display:none; margin-top:8px; padding:6px 12px;
                    background:#e8f5e9; border:1px solid #4caf50;
                    border-radius:999px; font-size:13px; color:#2e7d32;
                    align-items:center; gap:8px; width:fit-content;">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24"
               fill="none" stroke="#2e7d32" stroke-width="2.5"
               stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <span id="niComboChipLabel"></span>
          <span id="niComboClearBtn"
                style="cursor:pointer; font-size:15px; color:#888; margin-left:4px;"
                title="Limpiar selecci√≥n">√ó</span>
        </div>
      </div>

      <div class="grid-3" style="margin-top:12px;">
        <div>
          <label>C√≥digo Solvia</label>
          <input th:field="*{solviaCode}" placeholder="Ej: SOLVIA-123"/>
        </div>
        <div>
          <label>Tel√©fono</label>
          <input th:field="*{phone}" readonly/>
        </div>
        <div>
          <label>Email</label>
          <input th:field="*{email}" readonly/>
        </div>
      </div>
      <div class="grid-3" style="margin-top:0;">
        <div>
          <label>Municipio</label>
          <input th:field="*{municipality}" id="niMunicipality" placeholder="Ej: Madrid"/>
        </div>
        <div>
          <label>Tipo inmueble</label>
          <input th:field="*{propertyType}" id="niPropertyType" placeholder="Ej: Piso / Chalet"/>
        </div>
        <div>
          <label>C√≥digo inm.</label>
          <input th:field="*{propertyCode}" id="niPropertyCode" placeholder="Ej: 1234"/>
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Direcci√≥n</label>
          <input th:field="*{address}" id="niAddress" placeholder="Ej: Calle ..."/>
        </div>
      </div>

      <div><label>Comentarios</label><textarea th:field="*{comments}"></textarea></div>
      <button type="submit">Guardar interacci√≥n</button>
    </form>
  </div>

  <!-- EDITAR CLIENTE -->
  <div class="card" id="editar" style="margin-top:24px;">
    <h2>Editar cliente</h2>
    <div class="small">Modificar datos del cliente</div>
    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <form th:action="@{|/clientes/${client.id}/editar|}" th:object="${form}" method="post">
      <input type="hidden" th:field="*{id}" />
      <div class="grid">
        <div><label>Tipo</label>
          <select th:field="*{clientType}">
            <option th:each="t : ${clientTypes}" th:value="${t}" th:text="${t}"></option>
          </select>
        </div>
        <div><label>Nombre</label><input th:field="*{fullName}" /></div>
      </div>
      <div class="grid">
        <div><label>Empresa (opcional)</label><input th:field="*{companyName}" placeholder="Nombre de la empresa..." /></div>
        <div><label>C√≥digo Solvia</label><input th:field="*{solviaCode}" placeholder="Ej: SOLVIA-123" /></div>
      </div>
      <div class="grid-3">
        <div><label>Tel√©fono 1</label><input th:field="*{phone1}" />
          <div class="field-error" th:if="${#fields.hasErrors('phone1')}" th:errors="*{phone1}"></div></div>
        <div><label>Tel√©fono 2</label><input th:field="*{phone2}" />
          <div class="field-error" th:if="${#fields.hasErrors('phone2')}" th:errors="*{phone2}"></div></div>
        <div><label>Tel√©fono 3</label><input th:field="*{phone3}" />
          <div class="field-error" th:if="${#fields.hasErrors('phone3')}" th:errors="*{phone3}"></div></div>
      </div>
      <div class="grid">
        <div><label>Email 1</label><input th:field="*{email1}" /></div>
        <div><label>Email 2</label><input th:field="*{email2}" /></div>
      </div>
      <div><label>Notas generales</label><textarea th:field="*{generalNotes}"></textarea></div>

      <!-- CHECKBOXES ESPECIALES -->
      <div style="margin-top:14px; padding:14px; border:1px solid var(--line);
                  border-radius:10px; background:#faf8f4;">
        <div style="display:flex; gap:24px; flex-wrap:wrap;">

          <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; margin:0;">
            <input type="checkbox" th:field="*{posibleOcupa}" id="chkPosibleOcupa"/>
            <span style="display:inline-flex; align-items:center; gap:6px;
                         color:#b42318; font-weight:700; text-transform:uppercase; font-size:13px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                   fill="none" stroke="#b42318" stroke-width="2.5"
                   stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              Posible Okupa
            </span>
          </label>

          <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; margin:0;">
            <input type="checkbox" th:field="*{preVenda}" id="chkPreVenda"/>
            <span style="display:inline-flex; align-items:center; gap:6px;
                         color:#a05800; font-weight:700; text-transform:uppercase; font-size:13px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                   fill="none" stroke="#e07a18" stroke-width="2.5"
                   stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              ‚è≥ Pre Venda
            </span>
          </label>

          <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; margin:0;">
            <input type="checkbox" th:field="*{compradorFinal}" id="chkCompradorFinal"/>
            <span style="display:inline-flex; align-items:center; gap:6px;
                         color:#168a53; font-weight:700; text-transform:uppercase; font-size:13px;">
              üí∞ Comprador
            </span>
          </label>
        </div>

        <!-- Panel Pre Venda -->
        <div id="panelPreVenda"
             th:style="${form.preVenda} ? 'display:block;' : 'display:none;'"
             style="margin-top:14px; padding:12px; border:1px solid #f5c18a;
                    border-radius:8px; background:#fffbf4;">
          <label style="font-weight:600; color:#a05800; margin-bottom:6px; display:block;">
            üè† ¬øQu√© inmueble(s) marcar como Pre Vendido?
            <span class="small" style="color:#555;">(puedes marcar varios)</span>
          </label>
          <div class="small" style="margin-bottom:10px; color:#555;">
            Los inmuebles seleccionados se marcar√°n como <strong style="color:#e07a18;">‚è≥ pre vendido</strong> en el cat√°logo.
          </div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <label th:each="it : ${interactions}"
                   style="display:inline-flex; align-items:center; gap:8px;
                          padding:8px 12px; border:1px solid #f5c18a;
                          border-radius:8px; background:#fff; cursor:pointer;">
              <input type="checkbox" name="preVendaPropertyIds"
                     th:value="${it.property.id}"
                     th:checked="${form.preVendaPropertyIds != null
                                   and form.preVendaPropertyIds.contains(it.property.id)}"/>
              <span>
                <strong th:text="${it.property.propertyCode}">COD</strong>
                <span th:if="${it.property.propertyType != null}"
                      th:text="${' ¬∑ ' + it.property.propertyType}"></span>
                <span th:if="${it.property.municipality != null}"
                      th:text="${' ¬∑ ' + it.property.municipality}"></span>
                <span th:if="${it.property.preVendido}"
                      style="margin-left:6px; font-size:11px; color:#a05800; font-weight:700;">
                  ‚è≥ ya pre vendido
                </span>
                <span th:if="${it.property.sold}"
                      style="margin-left:6px; font-size:11px; color:#168a53; font-weight:700;">
                  ‚úì ya comprado
                </span>
              </span>
            </label>
          </div>
          <div class="small" style="margin-top:8px; color:#888;">
            Si el inmueble ya est√° vendido no se modificar√°.
          </div>
        </div>

        <!-- Panel Comprador -->
        <div id="panelInmuebleComprado"
             th:style="${form.compradorFinal} ? 'display:block;' : 'display:none;'"
             style="margin-top:14px; padding:12px; border:1px solid #a5d6a7;
                    border-radius:8px; background:#f1f8f1;">
          <label style="font-weight:600; color:#168a53; margin-bottom:6px; display:block;">
            üè† ¬øQu√© inmueble(s) compr√≥?
            <span class="small" style="color:#555;">(puedes marcar varios)</span>
          </label>
          <div class="small" style="margin-bottom:10px; color:#555;">
            Los inmuebles seleccionados se marcar√°n como <strong>vendido</strong>.
            El resto de interacciones pasar√°n a <strong style="color:#b02cff;">DESCARTA</strong>.
          </div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <label th:each="it : ${interactions}"
                   style="display:inline-flex; align-items:center; gap:8px;
                          padding:8px 12px; border:1px solid #a5d6a7;
                          border-radius:8px; background:#fff; cursor:pointer;">
              <input type="checkbox" name="purchasedPropertyIds"
                     th:value="${it.property.id}"
                     th:checked="${form.purchasedPropertyIds != null
                                   and form.purchasedPropertyIds.contains(it.property.id)}"/>
              <span>
                <strong th:text="${it.property.propertyCode}">COD</strong>
                <span th:if="${it.property.propertyType != null}"
                      th:text="${' ¬∑ ' + it.property.propertyType}"></span>
                <span th:if="${it.property.municipality != null}"
                      th:text="${' ¬∑ ' + it.property.municipality}"></span>
                <span th:if="${it.property.sold}"
                      style="margin-left:6px; font-size:11px; color:#168a53; font-weight:700;">
                  ‚úì ya comprado
                </span>
              </span>
            </label>
          </div>
          <div class="small" style="margin-top:8px; color:#888;">
            Si el inmueble ya est√° marcado como vendido no cambiar√° nada.
          </div>
        </div>

      </div>

      <button type="submit" style="margin-top:16px;">Guardar</button>
    </form>
  </div>

</div>

<!-- Cat√°logo de inmuebles para el combobox -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const CATALOG = /*[[${catalogProperties}]]*/ [];
  /*]]>*/
</script>

<script>
(function () {

  /* ‚îÄ‚îÄ CSRF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const csrfToken  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COMBOBOX ‚Äî Nueva interacci√≥n
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const comboInput    = document.getElementById('niComboInput');
  const dropdown      = document.getElementById('niComboDropdown');
  const chip          = document.getElementById('niComboChip');
  const chipLabel     = document.getElementById('niComboChipLabel');
  const comboClearBtn = document.getElementById('niComboClearBtn');
  const wrapper       = document.getElementById('niComboWrapper');

  let currentHighlight = -1;
  let visibleOptions   = [];

  const allItems = (CATALOG || [])
    .filter(p => !p.sold)
    .map(p => ({
      code        : p.propertyCode  || '',
      type        : p.propertyType  || '',
      address     : p.address       || '',
      municipality: p.municipality  || '',
      preVendido  : p.preVendido    || false,
      label       : [p.propertyCode, p.propertyType, p.municipality]
                      .filter(Boolean).join(' ¬∑ ')
    }));

  function escHtml(str) {
    return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function renderDropdown(q) {
    dropdown.innerHTML  = '';
    currentHighlight    = -1;
    const lq = (q || '').trim().toLowerCase();
    visibleOptions = lq === ''
      ? allItems
      : allItems.filter(item =>
          item.code.toLowerCase().includes(lq)         ||
          item.type.toLowerCase().includes(lq)         ||
          item.municipality.toLowerCase().includes(lq) ||
          item.address.toLowerCase().includes(lq)
        );

    if (visibleOptions.length === 0) {
      dropdown.innerHTML = '<div class="combo-empty">Sin resultados</div>';
      return;
    }
    visibleOptions.forEach((item, idx) => {
      const div = document.createElement('div');
      div.className   = 'combo-option';
      div.dataset.idx = idx;
      const preTag = item.preVendido
        ? `<span style="margin-left:6px; font-size:10px; color:#a05800;
                        background:#fff4e6; border:1px solid #e07a18;
                        border-radius:999px; padding:1px 6px; font-weight:700;">
             ‚è≥ Pre vendido
           </span>`
        : '';
      div.innerHTML = `
        <div class="opt-code">${escHtml(item.code)}${preTag}</div>
        <div class="opt-sub">${escHtml([item.type, item.municipality, item.address].filter(Boolean).join(' ¬∑ '))}</div>
      `;
      div.addEventListener('mousedown', function (e) {
        e.preventDefault();
        selectItem(item);
      });
      dropdown.appendChild(div);
    });
  }

  function selectItem(item) {
    document.getElementById('niPropertyCode').value  = item.code;
    document.getElementById('niPropertyType').value  = item.type;
    document.getElementById('niAddress').value       = item.address;
    document.getElementById('niMunicipality').value  = item.municipality;
    comboInput.value      = item.label;
    comboInput.readOnly   = true;
    chipLabel.textContent = item.label;
    chip.style.display    = 'inline-flex';
    closeDropdown();
  }

  function clearSelection() {
    comboInput.value    = '';
    comboInput.readOnly = false;
    chip.style.display  = 'none';
    document.getElementById('niPropertyCode').value  = '';
    document.getElementById('niPropertyType').value  = '';
    document.getElementById('niAddress').value       = '';
    document.getElementById('niMunicipality').value  = '';
  }

  function openDropdown(q) { renderDropdown(q); dropdown.classList.add('open'); }
  function closeDropdown()  { dropdown.classList.remove('open'); currentHighlight = -1; }

  function setHighlight(idx) {
    const opts = dropdown.querySelectorAll('.combo-option');
    opts.forEach(o => o.classList.remove('highlighted'));
    if (idx >= 0 && idx < opts.length) {
      opts[idx].classList.add('highlighted');
      opts[idx].scrollIntoView({ block: 'nearest' });
      currentHighlight = idx;
    }
  }

  comboInput.addEventListener('click', function () {
    comboInput.readOnly = false;
    comboInput.value    = '';
    openDropdown('');
  });
  comboInput.addEventListener('input', function () { openDropdown(comboInput.value); });
  comboInput.addEventListener('keydown', function (e) {
    const opts = dropdown.querySelectorAll('.combo-option');
    if      (e.key === 'ArrowDown') { e.preventDefault(); setHighlight(Math.min(currentHighlight + 1, opts.length - 1)); }
    else if (e.key === 'ArrowUp')   { e.preventDefault(); setHighlight(Math.max(currentHighlight - 1, 0)); }
    else if (e.key === 'Enter')     { e.preventDefault(); if (currentHighlight >= 0 && visibleOptions[currentHighlight]) selectItem(visibleOptions[currentHighlight]); }
    else if (e.key === 'Escape')    { closeDropdown(); }
  });
  comboInput.addEventListener('blur', function () { setTimeout(closeDropdown, 150); });
  comboClearBtn.addEventListener('click', clearSelection);
  document.addEventListener('click', function (e) { if (!wrapper.contains(e.target)) closeDropdown(); });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PANEL PRE VENDA / COMPRADOR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const chkPreVenda   = document.getElementById('chkPreVenda');
  const panelPreVenda = document.getElementById('panelPreVenda');
  if (chkPreVenda && panelPreVenda) {
    chkPreVenda.addEventListener('change', function () {
      panelPreVenda.style.display = chkPreVenda.checked ? 'block' : 'none';
    });
  }

  const chkComprador = document.getElementById('chkCompradorFinal');
  const panel        = document.getElementById('panelInmuebleComprado');
  if (chkComprador && panel) {
    chkComprador.addEventListener('change', function () {
      panel.style.display = chkComprador.checked ? 'block' : 'none';
    });
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     NDA TOGGLE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  document.querySelectorAll('.nda-toggle').forEach(cb => {
    cb.addEventListener('change', async function () {
      const clientId      = cb.getAttribute('data-client-id');
      const interactionId = cb.getAttribute('data-interaction-id');
      const checked       = cb.checked;
      try {
        const res = await fetch(`/clientes/${clientId}/interacciones/${interactionId}/nda`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
          },
          body: 'ndaRequested=' + encodeURIComponent(String(checked))
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
      } catch (e) { cb.checked = !checked; alert('No se pudo actualizar NDA.'); }
    });
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TICKET SAVE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  document.querySelectorAll('.ticket-save').forEach(btn => {
    btn.addEventListener('click', async function () {
      const clientId      = btn.getAttribute('data-client-id');
      const interactionId = btn.getAttribute('data-interaction-id');
      const td            = btn.closest('td');
      const input         = td?.querySelector('.ticket-input');
      const feedback      = td?.querySelector('.ticket-feedback');
      if (!input) return;
      try {
        const res = await fetch(`/clientes/${clientId}/interacciones/${interactionId}/ticket`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
          },
          body: 'ticketCode=' + encodeURIComponent(input.value)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        if (feedback) {
          feedback.style.display = 'inline';
          setTimeout(() => { feedback.style.display = 'none'; }, 2000);
        }
      } catch (e) { alert('No se pudo guardar el ticket.'); }
    });
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STATUS DOTS + SELECT
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  function statusToClass(v) {
    const map = {
      'GRIS_SIN_CONTACTO'    : 'gris',
      'AZUL_VISITA_PROGRAMADA': 'azul-claro',
      'AZUL_VISITA_REALIZADA' : 'azul-oscuro',
      'NARANJA_QUIERE_VISITA' : 'naranja',
      'ROSA_DESCARTA'         : 'rosa',
      'VERDE_PENSANDO'        : 'verde',
      'AMARILLO_OFERTA'       : 'amarillo'
    };
    return map[v] || '';
  }
  function paintDot(el, v) {
    el.classList.remove('gris','azul-claro','azul-oscuro','naranja','rosa','verde','amarillo');
    const c = statusToClass(v); if (c) el.classList.add(c);
  }
  document.querySelectorAll('.status-dot').forEach(dot => paintDot(dot, dot.getAttribute('data-status')));

  document.querySelectorAll('.status-select').forEach(sel => {
    sel.setAttribute('data-old', sel.value);
    const dot = sel.closest('td')?.querySelector('.status-dot');
    if (dot) paintDot(dot, sel.value);
    sel.addEventListener('change', async function () {
      const clientId      = sel.getAttribute('data-client-id');
      const interactionId = sel.getAttribute('data-interaction-id');
      const value         = sel.value;
      const oldValue      = sel.getAttribute('data-old') || value;
      if (dot) paintDot(dot, value);
      try {
        const res = await fetch(`/clientes/${clientId}/interacciones/${interactionId}/status`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
          },
          body: 'status=' + encodeURIComponent(value)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        sel.setAttribute('data-old', value);
      } catch (e) {
        sel.value = oldValue;
        if (dot) paintDot(dot, oldValue);
        alert('No se pudo actualizar el estado.');
      }
    });
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COMMENTS SAVE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  document.querySelectorAll('.comments-save').forEach(btn => {
    btn.addEventListener('click', async function () {
      const clientId      = btn.getAttribute('data-client-id');
      const interactionId = btn.getAttribute('data-interaction-id');
      const td            = btn.closest('td');
      const textarea      = td?.querySelector('.comments-input');
      const feedback      = td?.querySelector('.comments-feedback');
      if (!textarea) return;
      try {
        const res = await fetch(`/clientes/${clientId}/interacciones/${interactionId}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
          },
          body: 'comments=' + encodeURIComponent(textarea.value)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        if (feedback) {
          feedback.style.display = 'inline';
          setTimeout(() => { feedback.style.display = 'none'; }, 2000);
        }
      } catch (e) { alert('No se pudo guardar el comentario.'); }
    });
  });

})();
</script>
</body>
</html>
