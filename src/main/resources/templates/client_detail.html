<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Cliente')}"></head>
<body>
<nav th:replace="~{fragments :: nav}"></nav>

<div class="container">

  <!-- PERFIL (solo info) -->
  <div class="card" style="border-left:6px solid var(--line);">
    <h2 th:text="${client.fullName}">Cliente</h2>
    <div class="small">Información del cliente</div>

    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <div class="grid">
      <div>
        <div class="small">Tipo</div>
        <div th:text="${client.clientType}">PARTICULAR</div>
      </div>

      <div>
        <div class="small">Código Solvia</div>
        <div th:text="${client.solviaCode != null and !#strings.isEmpty(client.solviaCode) ? client.solviaCode : '—'}">—</div>
      </div>

      <div>
        <div class="small">Teléfonos</div>
        <div>
          <span th:if="${#lists.isEmpty(client.phones)}">—</span>
          <span th:each="p,st : ${client.phones}"
                th:text="${p.phoneNumber} + ${!st.last ? ', ' : ''}">600000000</span>
        </div>
      </div>

      <div>
        <div class="small">Emails</div>
        <div>
          <span th:if="${#lists.isEmpty(client.emails)}">—</span>
          <span th:each="e,st : ${client.emails}"
                th:text="${e.email} + ${!st.last ? ', ' : ''}">mail@mail.com</span>
        </div>
      </div>

      <div style="grid-column: 1 / -1;">
        <div class="small">Notas</div>
        <div th:text="${client.generalNotes != null and !#strings.isEmpty(client.generalNotes) ? client.generalNotes : '—'}">—</div>
      </div>
    </div>

    <div class="actions">
      <a class="btn btn-secondary" th:href="@{|/clientes/${client.id}#editar|}">Editar</a>
      <a class="btn btn-secondary" th:href="@{/clientes}">Volver a clientes</a>
    </div>
  </div>

  <!-- INTERACCIONES -->
  <div class="card" style="margin-top:24px; border-top:3px solid var(--text);">
    <h2>Interacciones</h2>
    <div class="small">Histórico de contacto del cliente</div>

    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <table>
      <thead>
      <tr>
        <th>Fecha</th>
        <th>Inmueble</th>
        <th>NDA</th>
        <th>Canal</th>
        <th>Estado</th>
        <th>Comentarios</th>
      </tr>
      </thead>

      <tbody>
      <tr th:if="${#lists.isEmpty(interactions)}">
        <td colspan="6" class="small">Aún no hay interacciones registradas.</td>
      </tr>

      <tr th:each="it : ${interactions}">
        <td th:text="${#temporals.format(it.contactDate, 'dd/MM/yyyy')}">13/02/2026</td>

        <td>
          <div><strong th:text="${it.property.propertyCode}">-</strong></div>

          <div class="small"
               th:if="${it.property.propertyType != null and !#strings.isEmpty(it.property.propertyType)}"
               th:text="${it.property.propertyType}">Tipo</div>

          <div class="small"
               th:if="${it.property.address != null and !#strings.isEmpty(it.property.address)}"
               th:text="${it.property.address}">Dirección</div>

          <div class="small"
               th:if="${it.property.municipality != null and !#strings.isEmpty(it.property.municipality)}"
               th:text="${it.property.municipality}">Municipio</div>

          <div class="small"
               th:if="${it.property.notes != null and !#strings.isEmpty(it.property.notes)}"
               th:text="${it.property.notes}">Notas</div>
        </td>

        <!-- NDA -->
        <td style="text-align:center;">
          <input type="checkbox"
                 class="nda-toggle"
                 th:attr="data-client-id=${client.id},data-interaction-id=${it.id}"
                 th:checked="${it.ndaRequested}" />
        </td>

        <td th:text="${it.channel}">-</td>

        <!-- ESTADO editable + bolita dinámica -->
        <td>
          <select class="status-select"
                  th:attr="data-client-id=${client.id},data-interaction-id=${it.id}">
            <option th:each="s : ${statuses}"
                    th:value="${s}"
                    th:text="${s}"
                    th:selected="${s == it.status}">
            </option>
          </select>

          <span class="badge" title="Estado" style="margin-left:8px;">
            <span class="dot status-dot" th:attr="data-status=${it.status}"></span>
          </span>
        </td>

        <td th:text="${it.comments}">-</td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- NUEVA INTERACCIÓN -->
  <div class="card" style="margin-top:24px;">
    <h2>Nueva interacción</h2>
    <div class="small">Añadir un nuevo contacto del cliente</div>

    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <form th:action="@{|/clientes/${client.id}/interacciones|}" th:object="${newInteraction}" method="post">

      <div class="grid-3">
        <div>
          <label>Fecha</label>
          <input type="date" th:field="*{contactDate}" />
        </div>

        <div>
          <label>Canal (volvió a contactarnos)</label>
          <select th:field="*{channel}">
            <option th:each="c : ${channels}" th:value="${c}" th:text="${c}"></option>
          </select>
        </div>

        <div>
          <label>Estado</label>
          <select th:field="*{status}">
            <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
          </select>
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Código Solvia</label>
          <input th:field="*{solviaCode}" placeholder="Ej: SOLVIA-123" />
        </div>

        <div>
          <label>Teléfono (cliente)</label>
          <input th:field="*{phone}" readonly />
        </div>

        <div>
          <label>Email (cliente)</label>
          <input th:field="*{email}" readonly />
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label>Municipio</label>
          <input th:field="*{municipality}" placeholder="Ej: Madrid" />
        </div>

        <div>
          <label>Tipo inmueble</label>
          <input th:field="*{propertyType}" placeholder="Ej: Piso / Chalet" />
        </div>

        <div>
          <label>Código inm.</label>
          <input th:field="*{propertyCode}" placeholder="Ej: 1234" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Dirección</label>
          <input th:field="*{address}" placeholder="Ej: Calle ..." />
        </div>
      </div>

      <div>
        <label>Comentarios</label>
        <textarea th:field="*{comments}"></textarea>
      </div>

      <button type="submit">Guardar interacción</button>
    </form>
  </div>

  <!-- EDITAR (al final) -->
  <div class="card" id="editar" style="margin-top:24px;">
    <h2>Editar cliente</h2>
    <div class="small">Modificar datos del cliente</div>

    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <form th:action="@{|/clientes/${client.id}/editar|}" th:object="${form}" method="post">
      <input type="hidden" th:field="*{id}" />

      <div>
        <label>Tipo</label>
        <select th:field="*{clientType}">
          <option th:each="t : ${clientTypes}" th:value="${t}" th:text="${t}"></option>
        </select>
      </div>

      <div>
        <label>Nombre</label>
        <input th:field="*{fullName}" />
      </div>

      <div>
        <label>Código Solvia</label>
        <input th:field="*{solviaCode}" placeholder="Ej: SOLVIA-123" />
      </div>

      <div>
        <label>Teléfono 1</label>
        <input th:field="*{phone1}" />
      </div>
      <div>
        <label>Teléfono 2</label>
        <input th:field="*{phone2}" />
      </div>
      <div>
        <label>Teléfono 3</label>
        <input th:field="*{phone3}" />
      </div>

      <div>
        <label>Email 1</label>
        <input th:field="*{email1}" />
      </div>
      <div>
        <label>Email 2</label>
        <input th:field="*{email2}" />
      </div>

      <div>
        <label>Notas</label>
        <textarea th:field="*{generalNotes}"></textarea>
      </div>

      <button type="submit">Guardar</button>
    </form>
  </div>

</div>

<script>
  (function () {

    // NDA toggle
    const toggles = document.querySelectorAll('.nda-toggle');
    toggles.forEach(cb => {
      cb.addEventListener('change', async function () {
        const clientId = cb.getAttribute('data-client-id');
        const interactionId = cb.getAttribute('data-interaction-id');
        const checked = cb.checked;

        try {
          const res = await fetch(`/clientes/${clientId}/interacciones/${interactionId}/nda`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'ndaRequested=' + encodeURIComponent(String(checked))
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
        } catch (e) {
          cb.checked = !checked;
          alert('No se pudo actualizar NDA.');
        }
      });
    });

    function statusToClass(statusValue) {
      const map = {
        'AZUL_VISITA_PROGRAMADA': 'azul-claro',
        'AZUL_VISITA_REALIZADA': 'azul-oscuro',
        'NARANJA_QUIERE_VISITA': 'naranja',
        'ROSA_DESCARTA': 'rosa',
        'VERDE_PENSANDO': 'verde',
        'AMARILLO_OFERTA': 'amarillo'
      };
      return map[statusValue] || '';
    }

    function paintDot(dotEl, statusValue) {
      dotEl.classList.remove('azul-claro','azul-oscuro','naranja','rosa','verde','amarillo');
      const cls = statusToClass(statusValue);
      if (cls) dotEl.classList.add(cls);
      dotEl.setAttribute('data-status', statusValue);
    }

    function applyDotColor(selectEl, statusValue) {
      const td = selectEl.closest('td');
      const dot = td ? td.querySelector('.status-dot') : null;
      if (!dot) return;
      paintDot(dot, statusValue);
    }

    // pintar todas las bolitas al cargar
    document.querySelectorAll('.status-dot').forEach(dot => {
      const statusValue = dot.getAttribute('data-status');
      if (statusValue) paintDot(dot, statusValue);
    });

    // Status change
    const selects = document.querySelectorAll('.status-select');
    selects.forEach(sel => {
      sel.setAttribute('data-old', sel.value);
      applyDotColor(sel, sel.value);

      sel.addEventListener('change', async function () {
        const clientId = sel.getAttribute('data-client-id');
        const interactionId = sel.getAttribute('data-interaction-id');
        const value = sel.value;
        const oldValue = sel.getAttribute('data-old') || value;

        applyDotColor(sel, value);

        try {
          const res = await fetch(`/clientes/${clientId}/interacciones/${interactionId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'status=' + encodeURIComponent(value)
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          sel.setAttribute('data-old', value);
        } catch (e) {
          sel.value = oldValue;
          applyDotColor(sel, oldValue);
          alert('No se pudo actualizar el estado.');
        }
      });
    });

  })();
</script>

</body>
</html>
