<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Interesados')}"></head>
<body>
<nav th:replace="~{fragments :: nav}"></nav>

<div class="container">
  <div class="card">
    <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 style="margin-bottom:6px;">HistÃ³rico de interesados</h2>
        <div class="small">Selecciona emails y pulsa copiar para pegarlos directamente en tu correo.</div>
      </div>
      <div class="actions" style="margin-top:0;">
        <button type="button" id="copyEmailsBtn" disabled>Copiar (<span id="emailsCountInline">0</span>)</button>
        <a href="javascript:void(0)" class="btn btn-secondary" id="clearEmailsBtn" style="display:none;">Limpiar</a>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid var(--line); margin:12px 0;"/>

    <!-- FILTROS -->
    <form class="filters" th:action="@{/interesados}" method="get"
          style="padding:18px 20px; border-radius:14px;
                 border:1px solid var(--line); background:#faf8f4;">

      <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
             fill="none" stroke="var(--muted)" stroke-width="2.5"
             stroke-linecap="round" stroke-linejoin="round">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
        </svg>
        <span style="font-size:11px; font-weight:700; letter-spacing:1.2px;
                     text-transform:uppercase; color:var(--muted);">Filtros</span>
      </div>

      <!-- ESTADOS -->
      <div style="margin-bottom:14px;">
        <div style="font-size:11px; font-weight:700; letter-spacing:0.8px;
                    text-transform:uppercase; color:var(--muted); margin-bottom:8px;">
          Estado <span style="font-weight:400; text-transform:none; letter-spacing:0;">(puedes marcar varios)</span>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="GRIS_SIN_CONTACTO" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'GRIS_SIN_CONTACTO')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #d0d0d0; background:#f5f5f5; color:#555;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#9e9e9e;flex-shrink:0;"></span>
              Sin contacto
            </span>
          </label>
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="AZUL_VISITA_PROGRAMADA" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'AZUL_VISITA_PROGRAMADA')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #b3c4ff; background:#eef1ff; color:#0b1f5c;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#0b1f5c;flex-shrink:0;"></span>
              Visita programada
            </span>
          </label>
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="AZUL_VISITA_REALIZADA" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'AZUL_VISITA_REALIZADA')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #b3d9ff; background:#e8f4ff; color:#1565c0;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#5aa7ff;flex-shrink:0;"></span>
              Visita realizada
            </span>
          </label>
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="NARANJA_QUIERE_VISITA" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'NARANJA_QUIERE_VISITA')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #f5c18a; background:#fff4e6; color:#a05800;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#e07a18;flex-shrink:0;"></span>
              Quiere visita
            </span>
          </label>
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="ROSA_DESCARTA" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'ROSA_DESCARTA')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #d9a8ff; background:#f7eeff; color:#6a0fa0;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#b02cff;flex-shrink:0;"></span>
              Descarta
            </span>
          </label>
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="VERDE_PENSANDO" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'VERDE_PENSANDO')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #a5d6a7; background:#e8f5e9; color:#1b5e20;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#168a53;flex-shrink:0;"></span>
              Pensando
            </span>
          </label>
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" name="statuses" value="AMARILLO_OFERTA" style="display:none;"
                   th:checked="${#lists.contains(selectedStatuses, 'AMARILLO_OFERTA')}"/>
            <span class="filter-pill"
                  style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
                         border-radius:999px; font-size:12px; font-weight:600; cursor:pointer;
                         border:1.5px solid #ffe082; background:#fffde7; color:#795500;
                         user-select:none; transition:all .15s;">
              <span style="width:8px;height:8px;border-radius:50%;background:#f5c800;flex-shrink:0;"></span>
              Oferta
            </span>
          </label>
        </div>
      </div>

      <hr style="border:none; border-top:1px solid var(--line); margin:14px 0;"/>

      <!-- CANAL + FECHAS + BÃšSQUEDA -->
      <div class="grid" style="gap:10px; margin-bottom:12px;">
        <div>
          <label style="font-size:11px; font-weight:700; letter-spacing:0.8px;
                        text-transform:uppercase; color:var(--muted); margin:0 0 6px;">Canal</label>
          <select name="channel">
            <option value="" th:selected="${selectedChannel == null}">Todos</option>
            <option th:each="c : ${channels}" th:value="${c}" th:text="${c}"
                    th:selected="${selectedChannel == c}"></option>
          </select>
        </div>
        <div>
          <label style="font-size:11px; font-weight:700; letter-spacing:0.8px;
                        text-transform:uppercase; color:var(--muted); margin:0 0 6px;">Buscar</label>
          <input type="text" name="q"
                 placeholder="Cliente, empresa, cÃ³digo, direcciÃ³n, comentario..."
                 th:value="${q}"/>
        </div>
        <div>
          <label style="font-size:11px; font-weight:700; letter-spacing:0.8px;
                        text-transform:uppercase; color:var(--muted); margin:0 0 6px;">Desde</label>
          <input type="date" name="from" id="inputFrom" th:value="${from}"/>
        </div>
        <div>
          <label style="font-size:11px; font-weight:700; letter-spacing:0.8px;
                        text-transform:uppercase; color:var(--muted); margin:0 0 6px;">Hasta</label>
          <input type="date" name="to" id="inputTo" th:value="${to}"/>
        </div>
      </div>

      <!-- ACCIONES -->
      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
        <a class="btn btn-secondary" th:href="@{/interesados}"
           style="font-size:13px; padding:9px 16px;">Limpiar</a>
        <button type="submit"
                style="display:inline-flex; align-items:center; gap:7px;
                       font-size:13px; padding:9px 20px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2.5"
               stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
          Filtrar
        </button>
      </div>
    </form>

    <table style="margin-top:12px;">
      <thead>
      <tr>
        <th>Estado</th>
        <th>Fecha</th>
        <th>Cliente</th>
        <th>TelÃ©fonos</th>
        <th>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-start;">
            <span>Emails seleccionables</span>
            <label id="selectAllLabel"
                   style="display:inline-flex; align-items:center; gap:6px;
                          cursor:pointer; font-weight:400; font-size:12px;
                          padding:4px 10px; border:1px solid var(--line);
                          border-radius:999px; background:#f5f5f5;
                          user-select:none; white-space:nowrap;">
              <input type="checkbox" id="selectAllEmails" style="cursor:pointer;"/>
              <span id="selectAllText">Seleccionar todos</span>
            </label>
          </div>
        </th>
        <th>Inmueble</th>
        <th>Canal</th>
        <th>Comentarios</th>
      </tr>
      </thead>

      <tbody>
      <tr th:if="${#lists.isEmpty(items)}">
        <td colspan="8" class="small">No hay resultados.</td>
      </tr>

      <tr th:each="it : ${items}"
          th:attr="data-excluido=${it.client.posibleOcupa or it.client.compradorFinal} ? 'true' : null"
          th:style="${it.client.posibleOcupa
                      ? 'background:#fff5f5; border-left:3px solid #b42318;'
                      : it.client.compradorFinal and it.property.sold
                        ? 'background:#e8f5e9; border-left:3px solid #168a53;'
                        : it.client.compradorFinal
                          ? 'opacity:0.4;'
                          : ''}">

        <!-- ESTADO DOT -->
        <td>
          <span class="badge" title="Estado">
            <span class="dot-status status-dot" th:attr="data-status=${it.status}"></span>
          </span>
        </td>

        <!-- FECHA -->
        <td th:text="${#temporals.format(it.contactDate, 'dd/MM/yyyy')}">13/02/2026</td>

        <!-- CLIENTE -->
        <td>
          <a th:href="@{|/clientes/${it.client.id}|}"
             th:text="${it.client.fullName}"
             th:style="${it.client.posibleOcupa
                         ? 'color:#b42318; font-weight:700;'
                         : it.client.compradorFinal
                           ? 'color:#168a53; font-weight:700;'
                           : ''}">
            Cliente
          </a>
          <div th:if="${it.client.companyName != null and !#strings.isEmpty(it.client.companyName)}"
               class="small" style="color:#666;">
            (<span th:text="${it.client.companyName}"></span>)
          </div>
          <!-- Badge OKUPA -->
          <div th:if="${it.client.posibleOcupa}"
               style="margin-top:4px; display:inline-flex; align-items:center; gap:5px;
                      background:#ffebee; border:1px solid #b42318;
                      border-radius:999px; padding:2px 8px;
                      font-size:11px; color:#b42318; font-weight:800;
                      text-transform:uppercase; letter-spacing:0.3px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24"
                 fill="none" stroke="#b42318" stroke-width="2.5"
                 stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            OKUPA
          </div>
          <!-- Badge COMPRADOR -->
          <div th:if="${it.client.compradorFinal}"
               style="margin-top:4px; display:inline-flex; align-items:center; gap:5px;
                      background:#e8f5e9; border:1px solid #168a53;
                      border-radius:999px; padding:2px 8px;
                      font-size:11px; color:#168a53; font-weight:800;
                      text-transform:uppercase; letter-spacing:0.3px;
                      box-shadow:0 0 0 2px rgba(22,138,83,.10);">
            ðŸ’° COMPRADOR
          </div>
        </td>

        <!-- TELÃ‰FONOS -->
        <td>
          <span th:if="${phonesByClientId.get(it.client.id) == null}">â€”</span>
          <span th:each="p,st : ${phonesByClientId.get(it.client.id)}"
                th:text="${p.phoneNumber} + ${!st.last ? ', ' : ''}">600000000</span>
        </td>

        <!-- EMAILS SELECCIONABLES -->
        <td>
          <span th:if="${emailsByClientId.get(it.client.id) == null}">â€”</span>
          <span th:each="e,st : ${emailsByClientId.get(it.client.id)}"
                style="display:inline-flex; align-items:center; gap:8px;
                       margin-right:12px; margin-bottom:6px; padding:6px 10px;
                       border:1px solid var(--line); border-radius:999px; background:#ffffff;">
            <input type="checkbox" class="email-item" th:attr="data-email=${e.email}"/>
            <span th:text="${e.email}">email@demo.com</span>
          </span>
        </td>

        <!-- INMUEBLE -->
        <td th:style="${it.client.compradorFinal and it.property.sold
                        ? 'background:#d6f5e3; border-radius:8px; padding:10px;'
                        : ''}">
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <span style="font-size:12px; font-weight:800;">CÃ³digo</span>
            <span th:text="${it.property.propertyCode}">ABC123</span>
          </div>
          <div th:if="${it.property.propertyType != null and !#strings.isEmpty(it.property.propertyType)}"
               style="display:flex; gap:6px; flex-wrap:wrap;">
            <span style="font-size:12px; font-weight:800;">Tipo</span>
            <span th:text="${it.property.propertyType}">Piso</span>
          </div>
          <div th:if="${it.property.address != null and !#strings.isEmpty(it.property.address)}"
               style="display:flex; gap:6px; flex-wrap:wrap;">
            <span style="font-size:12px; font-weight:800;">DirecciÃ³n</span>
            <span th:text="${it.property.address}">Calle...</span>
          </div>
          <div th:if="${it.property.municipality != null and !#strings.isEmpty(it.property.municipality)}"
               style="display:flex; gap:6px; flex-wrap:wrap;">
            <span style="font-size:12px; font-weight:800;">Municipio</span>
            <span th:text="${it.property.municipality}">Madrid</span>
          </div>
          <!-- Chip comprado -->
          <div th:if="${it.property.sold}"
               style="margin-top:4px; display:inline-flex; align-items:center; gap:4px;
                      background:#e8f5e9; border:1px solid #168a53; border-radius:999px;
                      padding:2px 8px; font-size:11px; color:#168a53; font-weight:700;">
            ðŸ’° Comprado
          </div>
        </td>

        <!-- CANAL -->
        <td th:text="${it.channel}">IDEALISTA</td>

        <!-- COMENTARIOS -->
        <td th:text="${it.comments}">â€”</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {

    /* â”€â”€ Fecha "Hasta" = hoy si el servidor no envÃ­a valor â”€â”€ */
    const inputTo = document.getElementById('inputTo');
    if (inputTo && !inputTo.value) {
      inputTo.value = new Date().toISOString().split('T')[0];
    }

    /* â”€â”€ Pastillas de estado â”€â”€ */
    document.querySelectorAll('.filter-pill').forEach(pill => {
      const cb = pill.previousElementSibling;
      function sync() {
        if (cb.checked) {
          pill.style.outline       = '2.5px solid #111';
          pill.style.outlineOffset = '2px';
          pill.style.fontWeight    = '800';
        } else {
          pill.style.outline    = 'none';
          pill.style.fontWeight = '600';
        }
      }
      sync();
      cb.addEventListener('change', sync);
    });

    /* â”€â”€ Email copy â”€â”€ */
    const copyBtn      = document.getElementById('copyEmailsBtn');
    const clearBtn     = document.getElementById('clearEmailsBtn');
    const counter      = document.getElementById('emailsCountInline');
    const selectAllCb  = document.getElementById('selectAllEmails');
    const selectAllTxt = document.getElementById('selectAllText');

    function normalize(email) { return (email || '').trim().toLowerCase(); }

    function getSelectedEmails() {
      const set = new Set();
      document.querySelectorAll('.email-item:checked').forEach(cb => {
        const email = normalize(cb.getAttribute('data-email'));
        if (email) set.add(email);
      });
      return Array.from(set).sort();
    }

    /* Todos los checkboxes â€” usado solo para limpiar selecciÃ³n */
    function getAllEmailItems() {
      return Array.from(document.querySelectorAll('.email-item'));
    }

    /* Solo checkboxes de filas sin data-excluido (no okupa, no comprador) */
    function getSelectableEmailItems() {
      return Array.from(document.querySelectorAll('.email-item')).filter(cb => {
        return cb.closest('tr[data-excluido]') === null;
      });
    }

    function syncSelectAll() {
      const seleccionables = getSelectableEmailItems();
      const marcados       = seleccionables.filter(cb => cb.checked);

      if (seleccionables.length === 0 || marcados.length === 0) {
        selectAllCb.checked       = false;
        selectAllCb.indeterminate = false;
        selectAllTxt.textContent  = 'Seleccionar todos';
      } else if (marcados.length === seleccionables.length) {
        selectAllCb.checked       = true;
        selectAllCb.indeterminate = false;
        selectAllTxt.textContent  = 'Deseleccionar todos';
      } else {
        selectAllCb.checked       = false;
        selectAllCb.indeterminate = true;
        selectAllTxt.textContent  = `Seleccionar todos (${marcados.length}/${seleccionables.length})`;
      }
    }

    function renderState() {
      const list = getSelectedEmails();
      counter.textContent    = String(list.length);
      copyBtn.disabled       = list.length === 0;
      clearBtn.style.display = list.length === 0 ? 'none' : 'inline-flex';
      syncSelectAll();
      return list;
    }

    function clearSelection() {
      getAllEmailItems().forEach(cb => cb.checked = false);
      renderState();
    }

    /* "Seleccionar todos" solo actÃºa sobre filas seleccionables */
    selectAllCb.addEventListener('change', function () {
      getSelectableEmailItems().forEach(cb => cb.checked = selectAllCb.checked);
      renderState();
    });

    document.addEventListener('change', function (ev) {
      if (ev.target && ev.target.classList.contains('email-item')) renderState();
    });

    copyBtn.addEventListener('click', async function () {
      const list = renderState();
      if (list.length === 0) return;
      const text = list.join('; ');
      try { await navigator.clipboard.writeText(text); }
      catch (e) {
        const ta = document.createElement('textarea');
        ta.value = text; ta.setAttribute('readonly', 'readonly');
        ta.style.position = 'fixed'; ta.style.left = '-9999px';
        document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
      }
      clearSelection();
    });

    clearBtn.addEventListener('click', function () { clearSelection(); });
    renderState();

    /* â”€â”€ Dots de estado en tabla â”€â”€ */
    function statusToClass(v) {
      const map = {
        'GRIS_SIN_CONTACTO':      'gris',
        'AZUL_VISITA_PROGRAMADA': 'azul-claro',
        'AZUL_VISITA_REALIZADA':  'azul-oscuro',
        'NARANJA_QUIERE_VISITA':  'naranja',
        'ROSA_DESCARTA':          'rosa',
        'VERDE_PENSANDO':         'verde',
        'AMARILLO_OFERTA':        'amarillo'
      };
      return map[v] || '';
    }
    function paintDot(dotEl, v) {
      dotEl.classList.remove('gris','azul-claro','azul-oscuro','naranja','rosa','verde','amarillo');
      const cls = statusToClass(v);
      if (cls) dotEl.classList.add(cls);
      dotEl.setAttribute('data-status', v);
    }
    document.querySelectorAll('.status-dot').forEach(dot => {
      const v = dot.getAttribute('data-status');
      if (v) paintDot(dot, v);
    });

  })();
</script>
</body>
</html>
